---
title: "FlowGrid"
author: "Xinyi Lin"
date: "4/9/2021"
output: html_document
---

Generate large scRNA-seq data for FlowGrid.

The overall sample size should be around 500k

Three types of data:

* cell clusters with the same size

* 20 big clusters and 10 small clusters

* 10 big clusters(>5%), 10 medium clusters(1%-5%) and 10 small clusters(0.1%-0.5%; 500-2500)

The cluster size is defined based on [Park's paper, 2018](https://pubmed.ncbi.nlm.nih.gov/29622724/)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(tidyverse)
library(SeuratDisk)
library(SeuratWrappers)
```

```{r}
memory.limit(80000)
options(future.globals.maxSize = 80000 * 1024^2) # 80G memory
```

## 30 clusters with even sizes

```{r}
## simulate cells pool setting
cluster_num = 30
prob = rep(1/cluster_num, cluster_num)
batch_size = 200000
de_prob = rep(0.2, cluster_num)
setresolu = 0.5
```

```{r}
## simulate cells pool process
set.seed(123)
#params = readRDS("./data/mnnCT7params.rds")
params <- newSplatParams()
sim <- splatSimulate(params, batchCells = round(batch_size*prob), group.prob = prob, de.prob = de_prob)

## save file
sim_mat = counts(sim) %>% Matrix::Matrix(sparse = TRUE)
sim_seurat = CreateSeuratObject(counts = sim_mat, project="Splatter")
sim_seurat[['truth']] = sim@colData@listData$Batch
SaveH5Seurat(sim_seurat, filename = "/storage/holab/linxy/others/flowgrid_sim1.h5Seurat")
Convert("/storage/holab/linxy/others/flowgrid_sim1.h5Seurat", dest = "h5ad")
#zellkonverter::writeH5AD(sim, "D:/Data/others/flowgrid_sim1.h5ad")
```

### plot the UMAP of clusters

```{r}
sim_mat <- counts(sim)
origLabels = sim@colData@listData$Group
sim_mat_sub = sim_mat[,sample(1:dim(sim_mat)[2], 0.05*dim(sim_mat)[2])]
seuratObj <- CreateSeuratObject(counts = sim_mat_sub, project="Splatter")
seuratObj <- NormalizeData(seuratObj, verbose = FALSE)
seuratObj <- FindVariableFeatures(seuratObj, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seuratObj <- ScaleData(seuratObj)
seuratObj <- RunPCA(seuratObj, features = VariableFeatures(object = seuratObj))
seuratObj <- FindNeighbors(seuratObj, dims = 1:30, verbose = FALSE)
seuratObj <- FindClusters(seuratObj, resolution = setresolu, verbose = FALSE)
seuratObj <- RunUMAP(seuratObj, dims = 1:30, verbose = FALSE)
DimPlot(seuratObj, reduction = "umap")
```

### save as h5ad

```{r}
zellkonverter::writeH5AD(sim, "D:/Data/others/flowgrid_sim1.h5ad")
```

### Simulate three times

Do not have enough memory to simulate it at once, try to simulate three times and combine.

```{r}
cluster_num = 30/3
prob = rep(1/cluster_num, cluster_num)
batch_size = 200000/3
de_prob = rep(0.5, cluster_num)
setresolu = 0.5
```

```{r}
params <- newSplatParams()
sim <- splatSimulate(params, batchCells = round(batch_size*prob), group.prob = prob, de.prob = de_prob, seed = 1, verbose = FALSE)
sim_mat = counts(sim) %>% Matrix::Matrix(sparse = TRUE)
origLabels = sim@colData@listData$Batch
for (idx in 2:3){
  sim <- splatSimulate(params, batchCells = round(batch_size*prob), group.prob = prob, de.prob = de_prob, seed = idx, verbose = FALSE)
  mat_sub = counts(sim) %>% Matrix::Matrix(sparse = TRUE)
  sim_mat = cbind(sim_mat, mat_sub)
  origLabels = c(origLabels, sim@colData@listData$Batch)
}
```

```{r}
rm(sim)
rm(mat_sub)
sim_seurat = CreateSeuratObject(counts = sim_mat, project="Splatter")
sim_seurat[['truth']] = origLabels
SaveH5Seurat(sim_seurat, filename = "D:/Data/others/flowgrid_sim1.h5Seurat")
Convert("D:/Data/others/flowgrid_sim1.h5Seurat", dest = "h5ad")
```

## 20 large clusters + 10 small clusters

```{r}
## simulate cells pool setting
cluster_num = 30
prob = c(rep(0.001, 10), rep(0.99/20, 20))
batch_size = 200000
de_prob = rep(0.2, cluster_num)
setresolu = 0.5
```

```{r}
## simulate cells pool process
set.seed(123)
#params = readRDS("./data/mnnCT7params.rds")
params <- newSplatParams()
sim <- splatSimulate(params, batchCells = round(batch_size*prob), group.prob = prob, de.prob = de_prob)

## save file
sim_mat = counts(sim) %>% Matrix::Matrix(sparse = TRUE)
sim_seurat = CreateSeuratObject(counts = sim_mat, project="Splatter")
sim_seurat[['truth']] = sim@colData@listData$Batch
SaveH5Seurat(sim_seurat, filename = "D:/Data/others/flowgrid_sim2.h5Seurat")
Convert("D:/Data/others/flowgrid_sim2.h5Seurat", dest = "h5ad")
```

## 10 large clusters + 10 medium clusters + 10 small clusters

```{r}
## simulate cells pool setting
cluster_num = 30
prob = c(rep(0.001, 10), rep(0.01, 10), rep(0.89/10, 10))
batch_size = 200000
de_prob = rep(0.2, cluster_num)
setresolu = 0.5
```

```{r}
## simulate cells pool process
set.seed(123)
#params = readRDS("./data/mnnCT7params.rds")
params <- newSplatParams()
sim <- splatSimulate(params, batchCells = round(batch_size*prob), group.prob = prob, de.prob = de_prob)

## save file
sim_mat = counts(sim) %>% Matrix::Matrix(sparse = TRUE)
sim_seurat = CreateSeuratObject(counts = sim_mat, project="Splatter")
sim_seurat[['truth']] = sim@colData@listData$Batch
SaveH5Seurat(sim_seurat, filename = "/storage/holab/linxy/others/flowgrid_sim3.h5Seurat")
Convert("/storage/holab/linxy/others/flowgrid_sim3.h5Seurat", dest = "h5ad")
```

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```

